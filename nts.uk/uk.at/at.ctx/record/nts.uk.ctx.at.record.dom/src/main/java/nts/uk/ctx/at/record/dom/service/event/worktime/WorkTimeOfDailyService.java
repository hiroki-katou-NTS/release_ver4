package nts.uk.ctx.at.record.dom.service.event.worktime;

import java.util.Optional;

import javax.ejb.Stateless;
import javax.inject.Inject;

import nts.uk.ctx.at.record.dom.dailyprocess.calc.IntegrationOfDaily;
import nts.uk.ctx.at.shared.dom.schedule.basicschedule.BasicScheduleService;
import nts.uk.ctx.at.shared.dom.schedule.basicschedule.SetupType;
import nts.uk.ctx.at.shared.dom.workingcondition.WorkingConditionItem;
import nts.uk.ctx.at.shared.dom.workingcondition.WorkingConditionItemRepository;
import nts.uk.shr.com.time.calendar.period.DatePeriod;
@Stateless
public class WorkTimeOfDailyService {
	@Inject
	private BasicScheduleService basicService;
	@Inject
	private WorkingConditionItemRepository workingCondition;
	public IntegrationOfDaily correct(String companyId, IntegrationOfDaily working){
		if(working.getWorkInformation().getRecordInfo() == null
				|| working.getWorkInformation().getRecordInfo().getWorkTypeCode() == null) {
			return working;
		}
		String workType = working.getWorkInformation().getRecordInfo().getWorkTypeCode().v();                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
		//就業時間帯の必須チェック
		SetupType checkNeededOfWorkTime = basicService.checkNeededOfWorkTimeSetting(workType);
		if(checkNeededOfWorkTime == SetupType.NOT_REQUIRED) {
			working.getWorkInformation().getRecordInfo().setSiftCode(null);
		} else if(checkNeededOfWorkTime == SetupType.REQUIRED) {
			if(working.getWorkInformation().getRecordInfo().getWorkTimeCode() == null) {
				//社員の労働条件を取得する
				Optional<WorkingConditionItem> optWorkingCondition = workingCondition.getBySidAndPeriodOrderByStrD(working.getWorkInformation().getEmployeeId(),
						new DatePeriod(working.getWorkInformation().getYmd(),working.getWorkInformation().getYmd())).stream().findFirst();
				optWorkingCondition.ifPresent(x -> {
					x.getWorkCategory().getWeekdayTime().getWorkTimeCode().ifPresent(y -> {
						working.getWorkInformation().getRecordInfo().setSiftCode(y);
					});
				});
			}
		}
		return working;
	}
}
